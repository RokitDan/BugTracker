@using BugTracker.Models
@using BugTracker.Services.Interfaces
@using BugTracker.Enums
@using BugTracker.Data
@model BugTracker.Models.ViewModels.DashboardViewModel


@inject IBTRolesService _rolesService;
@inject IBTProjectService _projectService;



@if (User.Identity.IsAuthenticated)
{
    @* <h1>@Model.Company!.Name</h1>*@

    <h3>Current Projects</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Project Name</th>
                <th>Project Manager</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Progress</th>
            </tr>
        </thead>
        <tbody>
            @foreach (Project project in Model.Projects)
            {
                <tr>
                    <td>
                        <a asp-controller="Projects" asp-action="Details" asp-route-id="@project.Id">@project.Name</a>
                    </td>

                    @{
                        BTUser? projectManager = await _projectService.GetProjectManagerAsync(project.Id)!;


                        if (projectManager != null)
                        {
                            <td>@projectManager.FullName</td>
                        }
                        else
                        {
                            //@if (await _rolesService.IsUserInRoleAsync(projectManager!, "Admin"))
                            //{
                            //    <td><a asp-action="AssignProjectManager" asp-route-id="@project.Id">Assign PM</a></td>
                            //}
                            //else
                        //{
                            <td>No Project Manager Assigned</td>
                            //}
                        }
                    }

                    <td>@project.StartDate</td>
                    <td>@project.EndDate</td>

                    <td>
                        <div class="progress-container progress-info m-b-25">
                            <span class="progress-badge" style="font-size:small">Project Status</span>
                            <div class="progress">
                                @* Razor code block *@
                                @{
                                    var start = project.StartDate;
                                    var end = project.EndDate;
                                    var today = DateTime.Now;
                                    var percent = today >= end ? 100 : today < start ? 0 : Math.Round((today.Subtract(start)) / (end.Subtract(start)) * 100);
                                }
                                <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: @percent%;">
                                    @* Use Progress Bar code variable here *@
                                    <span class="progress-value">@percent%</span>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @*    <h3>Current Tickets</h3>
    <ul>
        @foreach (Ticket ticket in Model.Tickets)
        {
            <li><a asp-controller="Tickets" asp-action="Details">@ticket.Title</a></li>
        }
    </ul>*@

    <h3>Team Members</h3>
    <ul>
        @foreach (BTUser member in Model.Members)
        {
            <li>@member.FullName</li>
        }
    </ul>
}
else
{
    <p>LOG IN BUTTON HERE</p>
}